<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Fewbytes</title><link href="http://fonts.googleapis.com/css?family=Gentium+Basic:400,700,400italic" rel=stylesheet type=text/css><link href="http://fonts.googleapis.com/css?family=Open+Sans:700,400" rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title="Fewbytes &#187; Feed" href=http://www.fewbytes.com/feed/><link rel=alternate type=application/rss+xml title="Fewbytes &#187; Comments Feed" href=http://www.fewbytes.com/comments/feed/><script type=text/javascript>window._wpemojiSettings={"baseUrl":"http:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/www.fewbytes.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.3.1"}};!function(a,b,c){function d(a){var c=b.createElement("canvas"),d=c.getContext&&c.getContext("2d");return d&&d.fillText?(d.textBaseline="top",d.font="600 32px Arial","flag"===a?(d.fillText(String.fromCharCode(55356,56812,55356,56807),0,0),c.toDataURL().length>3e3):(d.fillText(String.fromCharCode(55357,56835),0,0),0!==d.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);</script><style type=text/css>img.wp-smiley,img.emoji{display:inline!important;border:none!important;box-shadow:none!important;height:1em!important;width:1em!important;margin:0 .07em!important;vertical-align:-.1em!important;background:0 0!important;padding:0!important}</style><link rel=stylesheet id=parent-style-css href=/css/style.css type=text/css media=all><link rel=stylesheet id=brosco-style-css href=/css/style2.css type=text/css media=all><script type=text/javascript src=http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js></script></head><body class="page-template-default group-blog"><div id=page class="hfeed site"><a class="skip-link screen-reader-text" href=#content>Skip to content</a><header id=masthead class=site-header role=banner><div class=header-inside><div class=logo><a href=http://www.fewbytes.com/ title=Fewbytes rel=home><img src=http://www.fewbytes.com/wp-content/uploads/2015/11/fewbytes-logo1.png alt=Fewbytes></a></div><nav id=site-navigation class=main-navigation role=navigation><button class=menu-toggle>Primary Menu</button><div class=menu-top-bar-container><ul id=menu-top-bar class=menu><li id=menu-item-374 class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-77 current_page_item menu-item-374"><a href=/>Home</a></li><li id=menu-item-89 class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-89"><a href=/posts/>Blog</a></li></ul></div></nav></header><div id=content class=site-content><section id=primary class=content-area><main class=site-main><div class=single-post><div class=container><article class="post type-post status-publish"><header class=entry-header><h1 class=entry-title>Using S3 as a cookbook store backend for chef-server 11</h1><div class=entry-meta><time class="entry-date published posted-on">October 25, 2013</time> | <span class=entry-author>Avishai Ish-Shalom</span></div></header><div class=entry-content><p>chef-server is a modular service - various tasks are delegated to different sub-services, one of which is Bookshelf, Chef&rsquo;s cookbook store in charge of storing and serving cookbook files. Bookshelf&rsquo;s API is S3 compatible by design (I can only assume Opscode are using S3 for their SAAS) and can be replaced with S3. Using S3 as the backend store makes sense for clustering, but there&rsquo;s very little information on the web on how to configure chef-server to use it. Luckily, the configuration is not very complex.</p><p>Create a new S3 bucket for Chef cookbooks and a new IAM user for Chef server. Give the new IAM user permissions for the bucket with a policy like this one:</p><pre><code>{
  &quot;Statement&quot;: [
    {
      &quot;Action&quot;: [
        &quot;s3:*&quot;
      ],
      &quot;Resource&quot;: [
        &quot;arn:aws:s3:::my-bookshelf-bucket/*&quot;
      ],
      &quot;Effect&quot;: &quot;Allow&quot;
    }
  ]
}
</code></pre><p>Install chef-server as usual from the Omnibus package, then edit /etc/chef-server/chef-server.rb:</p><pre><code>bookshelf['enable'] = false # we don't need the bookshelf service anymore
bookshelf['url'] = &quot;https://s3.amazonaws.com&quot;
bookshelf['access_key_id'] = 'AKIAIAUEDF124NTFAUQ'
bookshelf['secret_access_key'] = 'Ko+L40eraJAlskjdfabBa212VAasdfBAAKRL'
erchef['s3_bucket'] = 'my-bookshelf-bucket'
</code></pre><p>The <code>access_key_id</code> and <code>secret_access_key</code> are the credentials you got for the new IAM user. Now run <code>chef-server-ctl reconfigure</code> (as root) and viola!!</p><p><strong>Note:</strong> If you already configured chef server once you need to remove the old s3 keys from <code>/etc/chef-server/chef-server-secrets.json</code> before running <code>chef-server-ctl reconfigure</code></p><p><strong>Warning:</strong> If you previously uploaded cookbooks to this server you must sync bookshelf to your new S3 bucket. you can do this using any S3 client library. If you don&rsquo;t sync, Chef&rsquo;s cookbook metadata will be out of sync and you will be in a world of pain. The symptoms will be chef-client not being able to find cookbook files and knife cookbook upload won&rsquo;t upload the files since it figures they are already in bookshelf.</p></div></article></div><nav class="navigation post-navigation" role=navigation><h1 class=screen-reader-text>Post navigation</h1><div class=nav-links style=display:block><div class=nav-previous><a href=/autonomation-in-web-systems/ rel=prev><span class=meta-nav></span>Previous</a></div><div class=nav-next><a href=/thoughts-about-configuration-management/ rel=next>Next <span class=meta-nav></span></a></div></div></nav></div></main></section></div><footer id=colophon class=site-footer role=contentinfo><div class=site-info>&copy; Fewbytes</div></footer></div></body></html>